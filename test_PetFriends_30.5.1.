from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC


def test_all_pets_have_correct_data(driver):
    #неявное ожидание
    driver.implicitly_wait(10)

    driver.get('https://petfriends.skillfactory.ru/all_pets')

    # Явное ожидание
    wait = WebDriverWait(driver, 10)

    # Ожидание загрузки блока статистики
    stats = wait.until(
        EC.presence_of_element_located((By.CSS_SELECTOR, '.\\.col-sm-4.left'))
    )

    stats_text = stats.text.split('\n')
    pets_count = int(stats_text[1].split(': ')[1])

    wait.until(
        EC.presence_of_element_located((By.CSS_SELECTOR, 'tbody'))
    )

    pets = driver.find_elements(By.CSS_SELECTOR, 'tbody tr')

    assert len(pets) == pets_count, 'Количество питомцев не совпадает со статистикой'

    pets_with_photo = 0
    names = []
    unique_pets = set()

    for pet in pets:
        columns = pet.find_elements(By.TAG_NAME, 'td')

        img = columns[0].find_element(By.TAG_NAME, 'img')
        name = columns[1].text
        breed = columns[2].text
        age = columns[3].text

        assert name, 'У питомца отсутствует имя'
        assert breed, 'У питомца отсутствует порода'
        assert age, 'У питомца отсутствует возраст'

        names.append(name)
        unique_pets.add((name, breed, age))

        if img.get_attribute('src'):
            pets_with_photo += 1

    assert pets_with_photo >= pets_count / 2, 'Меньше половины питомцев с фото'
    assert len(names) == len(set(names)), 'Есть повторяющиеся имена питомцев'
    assert len(unique_pets) == pets_count, 'Есть повторяющиеся питомцы'
